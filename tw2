-- 中文注释：烟雾状火焰粒子尾托效果，带开关按钮，兼容手机端
-- 要通过容器在线加载此脚本，请将此脚本内容上传到支持raw文本的平台（如GitHub Gist、Pastebin等）
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local StarterGui = game:GetService("StarterGui")

-- 创建按钮GUI
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "ParticleTrailGui"
screenGui.ResetOnSpawn = false

local toggleButton = Instance.new("TextButton")
toggleButton.Name = "ToggleParticleTrail"
toggleButton.Size = UDim2.new(0, 160, 0, 60)
toggleButton.Position = UDim2.new(0.5, -80, 0.85, 0)
toggleButton.AnchorPoint = Vector2.new(0.5, 0)
toggleButton.Text = "粒子效果：开"
toggleButton.Font = Enum.Font.SourceSansBold
toggleButton.TextSize = 28
toggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
toggleButton.AutoButtonColor = true
toggleButton.Parent = screenGui

local particleEnabled = true
local particleEmitters = {}

-- 创建烟雾和烟雾状火焰粒子
local function createParticleEmitters(character)
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    -- 烟雾粒子
    local smoke = Instance.new("ParticleEmitter")
    smoke.Name = "SmokeTrail"
    smoke.Texture = "rbxasset://textures/particles/smoke_main.dds"
    smoke.Color = ColorSequence.new(Color3.fromRGB(80,80,80), Color3.fromRGB(180,180,180))
    smoke.Size = NumberSequence.new({NumberSequenceKeypoint.new(0, 1), NumberSequenceKeypoint.new(1, 2)})
    smoke.Transparency = NumberSequence.new({NumberSequenceKeypoint.new(0, 0.5), NumberSequenceKeypoint.new(1, 1)})
    smoke.Lifetime = NumberRange.new(0.6, 1.2)
    smoke.Rate = 30
    smoke.Speed = NumberRange.new(2, 4)
    smoke.Rotation = NumberRange.new(0, 360)
    smoke.Enabled = particleEnabled
    smoke.Parent = root

    -- 烟雾状火焰粒子（深紫色渐变，带尾托）
    local fire = Instance.new("ParticleEmitter")
    fire.Name = "FireTrail"
    fire.Texture = "rbxassetid://258128463" -- 官方烟雾贴图，更适合紫色烟雾火焰
    fire.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(80, 0, 120)),      -- 深紫色
        ColorSequenceKeypoint.new(0.2, Color3.fromRGB(120, 0, 180)),   -- 紫色
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(60, 0, 80)),     -- 暗紫
        ColorSequenceKeypoint.new(0.8, Color3.fromRGB(30, 0, 40)),     -- 更暗紫
        ColorSequenceKeypoint.new(1, Color3.fromRGB(10, 0, 20))        -- 黑紫色，末端
    })
    fire.Size = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 2.2),      -- 起始较大
        NumberSequenceKeypoint.new(0.2, 2.8),    -- 扩散
        NumberSequenceKeypoint.new(0.6, 4.5),    -- 拖尾变大
        NumberSequenceKeypoint.new(1, 7)         -- 尾部最大，虚化
    })
    fire.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 0.08),     -- 中心亮
        NumberSequenceKeypoint.new(0.3, 0.25),   -- 渐隐
        NumberSequenceKeypoint.new(0.7, 0.7),    -- 尾部虚化
        NumberSequenceKeypoint.new(1, 1)         -- 完全透明
    })
    fire.Lifetime = NumberRange.new(1.2, 2.2)
    fire.Rate = 60
    fire.Speed = NumberRange.new(3, 7)
    fire.Rotation = NumberRange.new(0, 360)
    fire.Enabled = particleEnabled
    fire.LightEmission = 0.15 -- 降低光照，更烟雾感
    fire.Parent = root

    particleEmitters = {smoke, fire}
end

-- 移除粒子
local function removeParticleEmitters(character)
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    for i, emitter in particleEmitters do
        if emitter and emitter.Parent == root then
            emitter:Destroy()
        end
    end
    particleEmitters = {}
end

-- 切换粒子效果
local function toggleParticles()
    particleEnabled = not particleEnabled
    toggleButton.Text = "粒子效果：" .. (particleEnabled and "开" or "关")
    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    if particleEnabled then
        removeParticleEmitters(character)
        createParticleEmitters(character)
    else
        removeParticleEmitters(character)
    end
end

toggleButton.MouseButton1Click:Connect(toggleParticles)

-- 角色加载时自动添加粒子
local function onCharacterAdded(character)
    if particleEnabled then
        createParticleEmitters(character)
    end
end

LocalPlayer.CharacterAdded:Connect(onCharacterAdded)
if LocalPlayer.Character then
    onCharacterAdded(LocalPlayer.Character)
end

-- 添加GUI到玩家屏幕
screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- 角色移动检测，静止时不产生粒子
local lastCharacter = nil
local movementThreshold = 1.5 -- 速度阈值，低于此值认为静止

local function updateParticleState()
    while true do
        task.wait(0.1)
        local character = LocalPlayer.Character
        if not character then continue end
        local root = character:FindFirstChild("HumanoidRootPart")
        if not root then continue end
        -- 检查粒子是否启用
        if particleEnabled and #particleEmitters > 0 then
            local velocity = root.Velocity
            local speed = velocity.Magnitude
            local shouldEnable = speed > movementThreshold
            for i, emitter in particleEmitters do
                emitter.Enabled = shouldEnable
            end
        end
    end
end

-- 角色切换时重置粒子引用
LocalPlayer.CharacterAdded:Connect(function(character)
    lastCharacter = character
end)
if LocalPlayer.Character then
    lastCharacter = LocalPlayer.Character
end

-- 启动移动检测循环
task.spawn(updateParticleState)
