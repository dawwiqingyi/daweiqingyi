-- 烟雾火焰粒子控制逻辑（与彩虹拖尾保持一致的控制方式）
-- 全局存储，与彩虹拖尾使用相同的状态管理方式
getgenv().smokeFlame = {
    enabled = false,
    instances = {},
    connection = nil,
    stop = function() end  -- 用于停止效果的空函数，初始化用
}

-- 粒子核心逻辑（封装为独立函数，供开关调用）
local function createSmokeFlame(character)
    -- 清理旧实例
    for _, instance in ipairs(getgenv().smokeFlame.instances) do
        if instance and instance.Parent then
            instance:Destroy()
        end
    end
    getgenv().smokeFlame.instances = {}
    
    -- 验证角色有效性
    local root = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChild("Humanoid")
    if not (root and humanoid and humanoid.Health > 0) then
        return false
    end

    -- 创建烟雾粒子
    local smoke = Instance.new("ParticleEmitter")
    smoke.Name = "SmokeTrail_" .. game:GetService("Players").LocalPlayer.Name
    smoke.Texture = "rbxasset://textures/particles/smoke_main.dds"
    smoke.Color = ColorSequence.new(Color3.fromRGB(80,80,80), Color3.fromRGB(180,180,180))
    smoke.Size = NumberSequence.new({NumberSequenceKeypoint.new(0, 1), NumberSequenceKeypoint.new(1, 2)})
    smoke.Transparency = NumberSequence.new({NumberSequenceKeypoint.new(0, 0.5), NumberSequenceKeypoint.new(1, 1)})
    smoke.Lifetime = NumberRange.new(0.6, 1.2)
    smoke.Rate = 30
    smoke.Speed = NumberRange.new(2, 4)
    smoke.Rotation = NumberRange.new(0, 360)
    smoke.Enabled = true
    smoke.Parent = root
    table.insert(getgenv().smokeFlame.instances, smoke)

    -- 创建火焰粒子
    local fire = Instance.new("ParticleEmitter")
    fire.Name = "FireTrail_" .. game:GetService("Players").LocalPlayer.Name
    fire.Texture = "rbxassetid://258128463"
    fire.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(80, 0, 120)),
        ColorSequenceKeypoint.new(0.2, Color3.fromRGB(120, 0, 180)),
        ColorSequenceKeypoint.new(0.5, Color3.fromRGB(60, 0, 80)),
        ColorSequenceKeypoint.new(0.8, Color3.fromRGB(30, 0, 40)),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(10, 0, 20))
    })
    fire.Size = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 2.2),
        NumberSequenceKeypoint.new(0.2, 2.8),
        NumberSequenceKeypoint.new(0.6, 4.5),
        NumberSequenceKeypoint.new(1, 7)
    })
    fire.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 0.08),
        NumberSequenceKeypoint.new(0.3, 0.25),
        NumberSequenceKeypoint.new(0.7, 0.7),
        NumberSequenceKeypoint.new(1, 1)
    })
    fire.Lifetime = NumberRange.new(1.2, 2.2)
    fire.Rate = 60
    fire.Speed = NumberRange.new(3, 7)
    fire.Rotation = NumberRange.new(0, 360)
    fire.Enabled = true
    fire.LightEmission = 0.15
    fire.Parent = root
    table.insert(getgenv().smokeFlame.instances, fire)

    -- 移动检测（静止时关闭粒子）
    local movementThreshold = 1.5
    local updateConnection
    updateConnection = game:GetService("RunService").Heartbeat:Connect(function()
        if not getgenv().smokeFlame.enabled then
            updateConnection:Disconnect()
            return
        end
        
        local speed = root.Velocity.Magnitude
        local shouldEmit = speed > movementThreshold
        smoke.Enabled = shouldEmit
        fire.Enabled = shouldEmit
    end)
    
    -- 存储停止函数
    getgenv().smokeFlame.stop = function()
        if updateConnection then
            updateConnection:Disconnect()
        end
    end
    
    return true
end

-- 远程加载的主脚本（与彩虹拖尾链接格式一致）
local SMOKE_FLAME_LINK = "https://raw.githubusercontent.com/dawwiqingyi/daweiqingyi/refs/heads/main/smoke_flame"

-- 对外提供的控制接口（与彩虹拖尾API一致）
return function(enabled)
    local LocalPlayer = game:GetService("Players").LocalPlayer
    getgenv().smokeFlame.enabled = enabled
    
    -- 停止现有效果
    getgenv().smokeFlame.stop()
    
    -- 清理实例
    for _, instance in ipairs(getgenv().smokeFlame.instances) do
        if instance and instance.Parent then
            instance:Destroy()
        end
    end
    getgenv().smokeFlame.instances = {}
    
    -- 断开之前的重生连接
    if getgenv().smokeFlame.connection then
        getgenv().smokeFlame.connection:Disconnect()
    end
    
    if enabled then
        -- 角色重生监听（与彩虹拖尾逻辑一致）
        getgenv().smokeFlame.connection = LocalPlayer.CharacterAdded:Connect(function(character)
            task.spawn(function()
                -- 等待角色加载
                local root = character:WaitForChild("HumanoidRootPart", 5)
                if root then
                    createSmokeFlame(character)
                    print("✅ 角色重生，烟雾火焰已重新应用")
                end
            end)
        end)
        
        -- 应用到当前角色
        local currentChar = LocalPlayer.Character
        if currentChar then
            task.spawn(function()
                createSmokeFlame(currentChar)
            end)
        end
        
        -- 远程加载额外逻辑（与彩虹拖尾保持一致）
        local success, err = pcall(function()
            local scriptCode = game:HttpGet(SMOKE_FLAME_LINK)
            local runScript = loadstring(scriptCode)
            if runScript then
                runScript()
            end
        end)
        
        return success
    else
        -- 关闭状态
        print("❌ 烟雾火焰已关闭")
        return true
    end
end
    
