-- 烟雾状火焰粒子核心逻辑（无UI开关，默认关闭，移动时触发）
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- 全局变量：控制粒子启用状态、存储粒子实例（供外部控制）
getgenv().SmokeFireTrail = {
    Enabled = false,  -- 默认关闭（修改为false）
    Emitters = {}    -- 存储粒子发射器实例，用于清理
}

-- 清理旧粒子（防止角色重生时残留）
local function removeOldEmitters(character)
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    -- 清理当前角色的粒子
    for _, emitter in ipairs(SmokeFireTrail.Emitters) do
        if emitter and emitter.Parent == root then
            emitter:Destroy()
        end
    end
    SmokeFireTrail.Emitters = {}
end

-- 创建烟雾+火焰粒子
local function createParticles(character)
    -- 仅在启用状态下创建
    if not SmokeFireTrail.Enabled then return end
    
    local root = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not (root and humanoid and humanoid.Health > 0) then return end
    
    -- 先清理旧粒子
    removeOldEmitters(character)

    -- 1. 烟雾粒子（灰色调，增强层次感）
    local smokeEmitter = Instance.new("ParticleEmitter")
    smokeEmitter.Name = "SmokeTrail"
    smokeEmitter.Texture = "rbxasset://textures/particles/smoke_main.dds"
    smokeEmitter.Color = ColorSequence.new(
        Color3.fromRGB(80, 80, 80), 
        Color3.fromRGB(180, 180, 180)
    )
    smokeEmitter.Size = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 1), 
        NumberSequenceKeypoint.new(1, 2)
    })
    smokeEmitter.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 0.5), 
        NumberSequenceKeypoint.new(1, 1)
    })
    smokeEmitter.Lifetime = NumberRange.new(0.6, 1.2)
    smokeEmitter.Rate = 30
    smokeEmitter.Speed = NumberRange.new(2, 4)
    smokeEmitter.Rotation = NumberRange.new(0, 360)
    smokeEmitter.Parent = root

    -- 2. 烟雾状火焰粒子（深紫色拖尾，核心视觉效果）
    local fireEmitter = Instance.new("ParticleEmitter")
    fireEmitter.Name = "FireTrail"
    fireEmitter.Texture = "rbxassetid://258128463"  -- 官方烟雾贴图，适配紫色
    fireEmitter.Color = ColorSequence.new({
       ColorSequenceKeypoint.new(0, Color3.fromRGB(120, 0, 150)),    -- 深紫（起点）
    ColorSequenceKeypoint.new(0.2, Color3.fromRGB(160, 20, 180)), -- 亮紫
    ColorSequenceKeypoint.new(0.4, Color3.fromRGB(200, 100, 160)),-- 紫黄过渡（核心火焰色）
    ColorSequenceKeypoint.new(0.6, Color3.fromRGB(220, 150, 80)), -- 黄橙（火焰最亮处）
    ColorSequenceKeypoint.new(0.8, Color3.fromRGB(80, 20, 80)),   -- 暗紫橙
    ColorSequenceKeypoint.new(1, Color3.fromRGB(30, 0, 30))       -- 深紫黑（尾端）
    })
    fireEmitter.Size = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 2.2), 
        NumberSequenceKeypoint.new(0.2, 2.8), 
        NumberSequenceKeypoint.new(0.6, 4.5), 
        NumberSequenceKeypoint.new(1, 7)  -- 尾端放大，增强拖尾感
    })
    fireEmitter.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 0.08), 
        NumberSequenceKeypoint.new(0.3, 0.25), 
        NumberSequenceKeypoint.new(0.7, 0.7), 
        NumberSequenceKeypoint.new(1, 1)
    })
    fireEmitter.Lifetime = NumberRange.new(1.2, 2.2)
    fireEmitter.Rate = 60
    fireEmitter.Speed = NumberRange.new(3, 7)
    fireEmitter.Rotation = NumberRange.new(0, 360)
    fireEmitter.LightEmission = 0.19 -- 低光照，避免过亮
    fireEmitter.Parent = root

    -- 存储粒子实例
    table.insert(SmokeFireTrail.Emitters, smokeEmitter)
    table.insert(SmokeFireTrail.Emitters, fireEmitter)
end

-- 移动检测：静止时关闭粒子（节省性能）
local function updateParticleState()
    local lastRoot = nil
    while true do
        task.wait(0.1)
        -- 仅在启用状态下更新
        if not SmokeFireTrail.Enabled then
            -- 禁用时关闭所有粒子
            for _, emitter in ipairs(SmokeFireTrail.Emitters) do
                if emitter then emitter.Enabled = false end
            end
            continue
        end

        -- 获取当前角色根部件
        local character = LocalPlayer.Character
        local root = character and character:FindFirstChild("HumanoidRootPart")
        if not root then 
            lastRoot = nil
            continue 
        end

        -- 角色切换时重新创建粒子
        if root ~= lastRoot then
            createParticles(character)
            lastRoot = root
        end

        -- 检测移动速度：低于阈值（1.5）则关闭粒子
        local speed = root.Velocity.Magnitude
        local shouldShow = speed > 1.5
        for _, emitter in ipairs(SmokeFireTrail.Emitters) do
            if emitter then emitter.Enabled = shouldShow end
        end
    end
end

-- 角色重生时重新创建粒子（仅在启用状态下）
LocalPlayer.CharacterAdded:Connect(function(character)
    -- 等待角色加载完成（避免根部件未生成）
    local root = character:WaitForChild("HumanoidRootPart", 5)
    if root and SmokeFireTrail.Enabled then
        task.wait(0.2)  -- 延迟确保角色稳定
        createParticles(character)
    end
end)

-- 初始角色加载（如果角色已存在且启用状态为true）
if LocalPlayer.Character and SmokeFireTrail.Enabled then
    createParticles(LocalPlayer.Character)
end

-- 启动移动检测循环（独立协程，不阻塞主逻辑）
task.spawn(updateParticleState)

print("[烟雾火焰粒子] 加载完成，默认关闭（可通过 SmokeFireTrail.Enabled = true 开启）")
