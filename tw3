-- 烟雾状火焰粒子效果（仅核心逻辑，用于集成到现有UI）
-- 不包含UI创建，仅提供开关控制函数
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

-- 玩家相关设置
local LocalPlayer = Players.LocalPlayer

-- 粒子系统状态变量
local particleEnabled = false
local particleEmitters = {}
local movementThreshold = 1.5 -- 移动速度阈值

-- 创建烟雾和火焰粒子
local function createParticleEmitters(character)
    -- 先清理旧粒子
    removeParticleEmitters(character)
    
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    -- 烟雾粒子
    local smoke = Instance.new("ParticleEmitter")
    smoke.Name = "SmokeTrail"
    smoke.Texture = "rbxasset://textures/particles/smoke_main.dds"
    smoke.Color = ColorSequence.new(Color3.fromRGB(80,80,80), Color3.fromRGB(180,180,180))
    smoke.Size = NumberSequence.new({NumberSequenceKeypoint.new(0, 1), NumberSequenceKeypoint.new(1, 2)})
    smoke.Transparency = NumberSequence.new({NumberSequenceKeypoint.new(0, 0.5), NumberSequenceKeypoint.new(1, 1)})
    smoke.Lifetime = NumberRange.new(0.6, 1.2)
    smoke.Rate = 30
    smoke.Speed = NumberRange.new(2, 4)
    smoke.Rotation = NumberRange.new(0, 360)
    smoke.Enabled = particleEnabled
    smoke.Parent = root

    -- 火焰粒子（烟雾状）
    local fire = Instance.new("ParticleEmitter")
    fire.Name = "FireTrail"
    fire.Texture = "rbxassetid://258128463"
    fire.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(255, 100, 50)),   -- 火焰核心
        ColorSequenceKeypoint.new(0.3, Color3.fromRGB(255, 150, 50)), -- 火焰中部
        ColorSequenceKeypoint.new(0.6, Color3.fromRGB(255, 200, 100)),-- 火焰边缘
        ColorSequenceKeypoint.new(1, Color3.fromRGB(200, 150, 50))    -- 烟雾残留
    })
    fire.Size = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 2),
        NumberSequenceKeypoint.new(0.5, 4),
        NumberSequenceKeypoint.new(1, 6)
    })
    fire.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 0.1),
        NumberSequenceKeypoint.new(0.7, 0.5),
        NumberSequenceKeypoint.new(1, 1)
    })
    fire.Lifetime = NumberRange.new(1, 2)
    fire.Rate = 40
    fire.Speed = NumberRange.new(3, 6)
    fire.Rotation = NumberRange.new(0, 360)
    fire.Enabled = particleEnabled
    fire.LightEmission = 0.3
    fire.Parent = root

    -- 添加粒子到管理列表
    particleEmitters = {smoke, fire}
end

-- 移除粒子效果
local function removeParticleEmitters(character)
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    
    -- 清理管理列表中的粒子
    for _, emitter in ipairs(particleEmitters) do
        if emitter and emitter.Parent then
            emitter:Destroy()
        end
    end
    particleEmitters = {}
end

-- 移动检测：静止时不产生粒子
local function updateParticleState()
    while true do
        RunService.Heartbeat:Wait()
        local character = LocalPlayer.Character
        if not character or not particleEnabled then continue end
        
        local root = character:FindFirstChild("HumanoidRootPart")
        if not root then continue end
        
        -- 根据移动速度控制粒子发射
        local speed = root.Velocity.Magnitude
        local shouldEmit = speed > movementThreshold
        
        for _, emitter in ipairs(particleEmitters) do
            if emitter then
                emitter.Enabled = shouldEmit
            end
        end
    end
end

-- 角色加载时自动添加粒子（如果已启用）
local function onCharacterAdded(character)
    if particleEnabled then
        createParticleEmitters(character)
    end
end

-- 公开的开关控制函数，供现有UI调用
local function toggleParticles(state)
    -- 支持两种调用方式：toggleParticles() 切换状态，toggleParticles(true/false) 强制设置状态
    if state ~= nil then
        particleEnabled = state
    else
        particleEnabled = not particleEnabled
    end
    
    local character = LocalPlayer.Character
    if character then
        if particleEnabled then
            createParticleEmitters(character)
        else
            removeParticleEmitters(character)
        end
    end
    
    return particleEnabled -- 返回当前状态
end

-- 初始化
LocalPlayer.CharacterAdded:Connect(onCharacterAdded)
if LocalPlayer.Character then
    onCharacterAdded(LocalPlayer.Character)
end

-- 启动移动检测循环
coroutine.wrap(updateParticleState)()

-- 暴露接口给现有UI
return {
    toggle = toggleParticles,
    isEnabled = function() return particleEnabled end
}
    
