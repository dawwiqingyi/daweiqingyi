local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")

-- 1. 自动创建RemoteEvent（避免客户端找不到事件报错）
local ToggleEvent = ReplicatedStorage:FindFirstChild("ToggleIceParticle")
if not ToggleEvent then
    ToggleEvent = Instance.new("RemoteEvent")
    ToggleEvent.Name = "ToggleIceParticle"
    ToggleEvent.Parent = ReplicatedStorage
end

-- 2. 核心：创建极地冰粒子（原逻辑保留，优化容错）
local function createIceParticle()
    local emitter = Instance.new("ParticleEmitter")
    emitter.Name = "IceParticle"
    emitter.Texture = "rbxassetid://284205403" -- 冰雪贴图（确保ID有效）
    emitter.Color = ColorSequence.new(Color3.fromRGB(200, 230, 255), Color3.fromRGB(150, 200, 255))
    emitter.LightEmission = 0.7
    emitter.Size = NumberSequence.new({NumberSequenceKeypoint.new(0, 0.5), NumberSequenceKeypoint.new(1, 1.5)})
    emitter.Transparency = NumberSequence.new({NumberSequenceKeypoint.new(0, 0.2), NumberSequenceKeypoint.new(1, 1)})
    emitter.Rate = 30
    emitter.Lifetime = NumberRange.new(1, 2)
    emitter.Speed = NumberRange.new(0.5, 1.5)
    emitter.SpreadAngle = Vector2.new(360, 360)
    emitter.Enabled = true
    return emitter
end

-- 3. 核心：创建雪花粒子（3个不同层级，原逻辑保留）
local function createSnowParticle(index)
    local emitter = Instance.new("ParticleEmitter")
    emitter.Name = "SnowParticle" .. tostring(index)
    emitter.Texture = "rbxassetid://7733779476" -- 雪花贴图（确保ID有效）
    emitter.Color = ColorSequence.new(Color3.fromRGB(255, 255, 255), Color3.fromRGB(200, 220, 255))
    emitter.LightEmission = 0.5
    emitter.Size = NumberSequence.new({NumberSequenceKeypoint.new(0, 0.3 + 0.1 * index), NumberSequenceKeypoint.new(1, 0.7 + 0.2 * index)})
    emitter.Transparency = NumberSequence.new({NumberSequenceKeypoint.new(0, 0.1), NumberSequenceKeypoint.new(1, 1)})
    emitter.Rate = 10 + 5 * index
    emitter.Lifetime = NumberRange.new(1.5, 2.5)
    emitter.Speed = NumberRange.new(0.2 + 0.2 * index, 0.8 + 0.2 * index)
    emitter.SpreadAngle = Vector2.new(360, 360)
    emitter.Enabled = true
    return emitter
end

-- 4. 核心：开关粒子（原逻辑保留，优化角色加载容错）
local function toggleParticle(player, enable)
    -- 容错：确保角色和HumanoidRootPart存在
    if not player.Character then return end
    local root = player.Character:FindFirstChild("HumanoidRootPart")
    if not root then return end

    -- 查找已存在的粒子
    local existingIce = root:FindFirstChild("IceParticle")
    local snowParticles = {}
    for i = 1, 3 do
        snowParticles[i] = root:FindFirstChild("SnowParticle" .. tostring(i))
    end

    -- 开启：创建不存在的粒子
    if enable then
        if not existingIce then
            local emitter = createIceParticle()
            emitter.Parent = root
            print("[服务器] 为" .. player.Name .. "创建冰粒子")
        end
        for i = 1, 3 do
            if not snowParticles[i] then
                local snowEmitter = createSnowParticle(i)
                snowEmitter.Parent = root
            end
        end
    -- 关闭：销毁已存在的粒子
    else
        if existingIce then
            existingIce:Destroy()
            print("[服务器] 为" .. player.Name .. "销毁冰粒子")
        end
        for i = 1, 3 do
            if snowParticles[i] then
                snowParticles[i]:Destroy()
            end
        end
    end
end

-- 5. 接收客户端指令（关键：绑定RemoteEvent）
ToggleEvent.OnServerEvent:Connect(function(player, enable)
    -- 安全校验：确保是合法玩家发送的请求
    if not Players:FindFirstChild(player.Name) then return end
    toggleParticle(player, enable)
end)

-- 6. 角色重生处理：保留原逻辑（避免重生后粒子残留）
Players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function(character)
        local root = character:WaitForChild("HumanoidRootPart", 3)
        if not root then return end

        -- 重生时销毁旧粒子
        local existingIce = root:FindFirstChild("IceParticle")
        if existingIce then existingIce:Destroy() end
        for i = 1, 3 do
            local snow = root:FindFirstChild("SnowParticle" .. tostring(i))
            if snow then snow:Destroy() end
        end
    end)
end)

print("[服务器] 冰粒子脚本加载完成！")
