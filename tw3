-- 烟雾状火焰粒子核心逻辑（无UI开关，默认关闭，停止时保留少许火焰色）
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- 全局变量：控制粒子启用状态、存储粒子实例（供外部控制）
getgenv().SmokeFireTrail = {
    Enabled = false,  -- 默认关闭
    Emitters = {},    -- 存储粒子发射器实例
    -- 新增：粒子参数配置（区分移动/静止状态）
    ParticleConfig = {
        -- 移动时参数（原效果）
        Moving = {
            FireRate = 60,          -- 火焰粒子发射频率
            FireSizeStart = 2.2,    -- 火焰粒子初始大小
            FireSizeEnd = 7,        -- 火焰粒子尾端大小
            FireLifetime = NumberRange.new(1.2, 2.2), -- 火焰粒子生命周期
            SmokeRate = 30          -- 烟雾粒子发射频率
        },
        -- 静止时参数（少许火焰色）
        Idle = {
            FireRate = 3,           -- 极低发射频率（仅少量粒子）
            FireSizeStart = 1.5,    -- 粒子更小
            FireSizeEnd = 3,        -- 尾端缩小
            FireLifetime = NumberRange.new(3, 7), -- 生命周期延长（缓慢漂浮）
            SmokeRate = 0           -- 静止时关闭烟雾（只留火焰色）
        }
    }
}

-- 清理旧粒子（防止角色重生时残留）
local function removeOldEmitters(character)
    local root = character:FindFirstChild("HumanoidRootPart")
    if not root then return end
    for _, emitter in ipairs(SmokeFireTrail.Emitters) do
        if emitter and emitter.Parent == root then
            emitter:Destroy()
        end
    end
    SmokeFireTrail.Emitters = {}
end

-- 创建烟雾+火焰粒子（支持动态切换参数）
local function createParticles(character)
    if not SmokeFireTrail.Enabled then return end
    
    local root = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if not (root and humanoid and humanoid.Health > 0) then return end
    
    removeOldEmitters(character)
    local config = SmokeFireTrail.ParticleConfig.Moving -- 初始用移动参数

    -- 1. 烟雾粒子（仅移动时显示，静止时关闭）
    local smokeEmitter = Instance.new("ParticleEmitter")
    smokeEmitter.Name = "SmokeTrail"
    smokeEmitter.Texture = "rbxasset://textures/particles/smoke_main.dds"
    smokeEmitter.Color = ColorSequence.new(
        Color3.fromRGB(80, 80, 80), 
        Color3.fromRGB(180, 180, 180)
    )
    smokeEmitter.Size = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 1), 
        NumberSequenceKeypoint.new(1, 2)
    })
    smokeEmitter.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 0.5), 
        NumberSequenceKeypoint.new(1, 1)
    })
    smokeEmitter.Lifetime = NumberRange.new(0.6, 1.2)
    smokeEmitter.Rate = config.SmokeRate -- 绑定烟雾发射频率
    smokeEmitter.Speed = NumberRange.new(2, 4)
    smokeEmitter.Rotation = NumberRange.new(0, 360)
    smokeEmitter.Parent = root

    -- 2. 烟雾状火焰粒子（紫黄火焰色，支持动态参数）
    local fireEmitter = Instance.new("ParticleEmitter")
    fireEmitter.Name = "FireTrail"
    fireEmitter.Texture = "rbxassetid://258128463"
    -- 紫黄火焰色序列（保留原配色）
    fireEmitter.Color = ColorSequence.new({
        ColorSequenceKeypoint.new(0, Color3.fromRGB(120, 0, 150)),    -- 深紫（起点）
        ColorSequenceKeypoint.new(0.2, Color3.fromRGB(160, 20, 180)), -- 亮紫
        ColorSequenceKeypoint.new(0.4, Color3.fromRGB(200, 100, 160)),-- 紫黄过渡（核心）
        ColorSequenceKeypoint.new(0.6, Color3.fromRGB(220, 150, 80)), -- 黄橙（最亮）
        ColorSequenceKeypoint.new(0.8, Color3.fromRGB(80, 20, 80)),   -- 暗紫橙
        ColorSequenceKeypoint.new(1, Color3.fromRGB(30, 0, 30))       -- 深紫黑（尾端）
    })
    -- 初始绑定移动时的大小序列
    fireEmitter.Size = NumberSequence.new({
        NumberSequenceKeypoint.new(0, config.FireSizeStart), 
        NumberSequenceKeypoint.new(0.2, config.FireSizeStart + 0.6), 
        NumberSequenceKeypoint.new(0.6, config.FireSizeStart + 2.3), 
        NumberSequenceKeypoint.new(1, config.FireSizeEnd)
    })
    fireEmitter.Transparency = NumberSequence.new({
        NumberSequenceKeypoint.new(0, 0.08), 
        NumberSequenceKeypoint.new(0.3, 0.25), 
        NumberSequenceKeypoint.new(0.7, 0.7), 
        NumberSequenceKeypoint.new(1, 1)
    })
    fireEmitter.Lifetime = config.FireLifetime -- 绑定生命周期
    fireEmitter.Rate = config.FireRate         -- 绑定发射频率
    fireEmitter.Speed = NumberRange.new(3, 7)
    fireEmitter.Rotation = NumberRange.new(0, 360)
    fireEmitter.LightEmission = 0.25 -- 略微提高光照，让静止时的火焰色更明显
    fireEmitter.Parent = root

    -- 存储粒子实例（标记类型，方便后续修改参数）
    table.insert(SmokeFireTrail.Emitters, {Type = "Smoke", Emitter = smokeEmitter})
    table.insert(SmokeFireTrail.Emitters, {Type = "Fire", Emitter = fireEmitter})
end

-- 新增：更新粒子参数（根据移动/静止状态切换）
local function updateParticleParams(isMoving)
    local config = isMoving 
        and SmokeFireTrail.ParticleConfig.Moving 
        or SmokeFireTrail.ParticleConfig.Idle

    -- 遍历所有粒子发射器，更新参数
    for _, item in ipairs(SmokeFireTrail.Emitters) do
        local emitter = item.Emitter
        if not emitter or not emitter.Parent then continue end

        if item.Type == "Smoke" then
            -- 烟雾粒子：静止时关闭（Rate=0），移动时恢复
            emitter.Rate = config.SmokeRate
        elseif item.Type == "Fire" then
            -- 火焰粒子：动态更新频率、大小、生命周期
            emitter.Rate = config.FireRate
            emitter.Lifetime = config.FireLifetime
            -- 重新设置大小序列（匹配当前状态）
            emitter.Size = NumberSequence.new({
                NumberSequenceKeypoint.new(0, config.FireSizeStart), 
                NumberSequenceKeypoint.new(0.2, config.FireSizeStart + 0.6), 
                NumberSequenceKeypoint.new(0.6, config.FireSizeStart + 2.3), 
                NumberSequenceKeypoint.new(1, config.FireSizeEnd)
            })
        end
    end
end

-- 移动检测：修改为“切换参数”而非“禁用粒子”
local function updateParticleState()
    local lastRoot = nil
    local lastIsMoving = false -- 记录上一帧是否移动，避免频繁切换参数
    while true do
        task.wait(0.1)
        if not SmokeFireTrail.Enabled then
            -- 禁用时才完全关闭粒子
            for _, item in ipairs(SmokeFireTrail.Emitters) do
                local emitter = item.Emitter
                if emitter then emitter.Enabled = false end
            end
            continue
        end

        local character = LocalPlayer.Character
        local root = character and character:FindFirstChild("HumanoidRootPart")
        if not root then 
            lastRoot = nil
            lastIsMoving = false
            continue 
        end

        -- 角色切换时重新创建粒子
        if root ~= lastRoot then
            createParticles(character)
            lastRoot = root
            lastIsMoving = false -- 重置移动状态
        end

        -- 检测移动状态（速度阈值保持1.5，可微调）
        local speed = root.Velocity.Magnitude
        local currentIsMoving = speed > 1.5

        -- 仅当状态变化时才更新参数（优化性能）
        if currentIsMoving ~= lastIsMoving then
            updateParticleParams(currentIsMoving)
            lastIsMoving = currentIsMoving
        end

        -- 始终保持粒子启用（关键：不再因静止禁用）
        for _, item in ipairs(SmokeFireTrail.Emitters) do
            local emitter = item.Emitter
            if emitter then emitter.Enabled = true end
        end
    end
end

-- 角色重生时重新创建粒子（仅在启用状态下）
LocalPlayer.CharacterAdded:Connect(function(character)
    local root = character:WaitForChild("HumanoidRootPart", 5)
    if root and SmokeFireTrail.Enabled then
        task.wait(0.2)
        createParticles(character)
        -- 初始设为静止状态（避免重生时默认移动参数）
        updateParticleParams(false)
    end
end)

-- 初始角色加载（如果角色已存在且启用）
if LocalPlayer.Character and SmokeFireTrail.Enabled then
    createParticles(LocalPlayer.Character)
    updateParticleParams(false) -- 初始静止
end

-- 启动移动检测循环
task.spawn(updateParticleState)

print("[烟雾火焰粒子] 加载完成")
