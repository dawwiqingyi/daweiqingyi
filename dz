local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- 全局开关变量
local waveRightHandEnabled = true

local function waveRightHand(character)
    if not waveRightHandEnabled then return end
    local rightArm = character:FindFirstChild("RightUpperArm") or character:FindFirstChild("Right Arm")
    local rightShoulder = nil
    -- R15和R6兼容
    if rightArm then
        for i, v in rightArm:GetChildren() do
            if v:IsA("Motor6D") and v.Name == "RightShoulder" then
                rightShoulder = v
                break
            end
        end
        if not rightShoulder and character:FindFirstChild("Torso") then
            rightShoulder = character.Torso:FindFirstChild("Right Shoulder")
        end
    end
    if not rightShoulder then return end

    local waving = true
    local angle = 0
    local amplitude = math.rad(60)
    local speed = 3

    -- 抬高右手
    rightShoulder.C0 = rightShoulder.C0 * CFrame.Angles(0, 0, math.rad(-60))

    -- 动画循环
    while waving and character.Parent do
        if not waveRightHandEnabled then break end
        angle = angle + speed * math.pi * 0.03
        local swing = math.sin(angle) * amplitude
        rightShoulder.C0 = rightShoulder.C0 * CFrame.Angles(0, swing, 0)
        task.wait(0.03)
        -- 检查是否停止
        if not character:GetAttribute("RightHandWaving") then
            break
        end
    end
    -- 还原
    rightShoulder.C0 = rightShoulder.C0
end

local function stopWave(character)
    character:SetAttribute("RightHandWaving", false)
end

ReplicatedStorage:WaitForChild("ToggleRightHandWave").OnServerEvent:Connect(function(player, waving)
    if not waveRightHandEnabled then return end
    local character = player.Character
    if not character then return end
    if waving then
        character:SetAttribute("RightHandWaving", true)
        waveRightHand(character)
    else
        stopWave(character)
    end
end)
